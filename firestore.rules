/**
 * @file Firestore Security Rules for AquaFlow
 * @core Philosophy: This ruleset enforces a strict user-ownership model for user-specific data,
 * and allows public read access to product information.  Admin roles are stored in the database.
 * @data Structure:
 *   - /users/{userId}: Stores user profiles and related data. Access is restricted to the owning user or an admin.
 *   - /products/{productId}: Stores product information. Publicly readable.
 *   - /deliveryRoutes/{deliveryRouteId}: Stores delivery route information. Only accessible by admins.
 *   - /roles_admin/{userId}: Indicates admin status. Document existence grants admin role.
 * @key Security Decisions:
 *   - User data is strictly controlled by user-ownership, with admin override for reads.
 *   - Product data is publicly readable, writable only by admins.
 *   - Delivery routes are only accessible to admins.
 *   - User and Order listing is allowed for admins.
 *   - Data validation is relaxed to allow for rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (get) An admin can read any user's profile. A user can read their own profile.
     * @allow (list) Only admins can list all users.
     * @allow (create) An authenticated user can create their own profile.
     * @allow (update) An authenticated user can update their own profile.
     * @allow (delete) An authenticated user can delete their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to user addresses.
     * @path /users/{userId}/addresses/{addressId}
     */
    match /users/{userId}/addresses/{addressId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create, update, delete: if isOwner(userId);
    }

    /**
     * @description Controls access to product information.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to order information.
     * @path /users/{userId}/orders/{orderId}
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update, delete: if isOwner(userId) || isAdmin();

      /**
       * @description Controls access to order item information.
       * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
       */
      match /orderItems/{orderItemId} {
         allow get, list: if isOwner(userId) || isAdmin();
         allow create, update, delete: if isOwner(userId);
      }
    }
    
    // This rule allows admins to perform a collection group query on 'orders'.
    match /{path=**}/orders/{orderId} {
      allow list: if isAdmin();
    }


    /**
     * @description Controls access to delivery route information.
     * @path /deliveryRoutes/{deliveryRouteId}
     */
    match /deliveryRoutes/{deliveryRouteId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to admin role assignment.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
        allow get: if isSignedIn();
        allow list, delete: if isAdmin();
        // Allows the designated admin user to create/update their own role document initially.
        allow create, update: if request.auth.uid == userId;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
